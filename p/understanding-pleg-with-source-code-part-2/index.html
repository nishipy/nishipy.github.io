<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="For the goal of this series or abstract of the PLEG and so on, please refer to the previous post Understanding PLEG with source code - Part 1. Now, let&amp;rsquo;s read the source code of PLEG! Note that the source code in the following part comes from Kubernetes 1.25.
pkg/kubelet/pleg/pleg.go The types of PodLifeCycleEvents in PLEG and their associated structures and interfaces are defined here. We have some events like ContainerStarted, ContainerDied, ContainerRemoved, PodSync and ContainerChanged."><title>Understanding PLEG with source code - Part 2</title><link rel=canonical href=https://nishipy.github.io/p/understanding-pleg-with-source-code-part-2/><link rel=stylesheet href=/scss/style.min.705a41b44c071e70a903c27edfdc8dd99defe50138c4cf4fc42239f4f01aca9e.css><meta property="og:title" content="Understanding PLEG with source code - Part 2"><meta property="og:description" content="For the goal of this series or abstract of the PLEG and so on, please refer to the previous post Understanding PLEG with source code - Part 1. Now, let&amp;rsquo;s read the source code of PLEG! Note that the source code in the following part comes from Kubernetes 1.25.
pkg/kubelet/pleg/pleg.go The types of PodLifeCycleEvents in PLEG and their associated structures and interfaces are defined here. We have some events like ContainerStarted, ContainerDied, ContainerRemoved, PodSync and ContainerChanged."><meta property="og:url" content="https://nishipy.github.io/p/understanding-pleg-with-source-code-part-2/"><meta property="og:site_name" content="/home/nishipy"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="openshift"><meta property="article:tag" content="kubelet"><meta property="article:tag" content="pleg"><meta property="article:published_time" content="2023-03-24T09:32:47+09:00"><meta property="article:modified_time" content="2023-03-24T09:32:47+09:00"><meta property="og:image" content="https://nishipy.github.io/p/understanding-pleg-with-source-code-part-2/pleg.png"><meta name=twitter:site content="@iamnishipy"><meta name=twitter:creator content="@iamnishipy"><meta name=twitter:title content="Understanding PLEG with source code - Part 2"><meta name=twitter:description content="For the goal of this series or abstract of the PLEG and so on, please refer to the previous post Understanding PLEG with source code - Part 1. Now, let&amp;rsquo;s read the source code of PLEG! Note that the source code in the following part comes from Kubernetes 1.25.
pkg/kubelet/pleg/pleg.go The types of PodLifeCycleEvents in PLEG and their associated structures and interfaces are defined here. We have some events like ContainerStarted, ContainerDied, ContainerRemoved, PodSync and ContainerChanged."><meta name=twitter:card content="summary"><meta name=twitter:image content="https://nishipy.github.io/p/understanding-pleg-with-source-code-part-2/pleg.png"><link rel="shortcut icon" href=/images/favicon.ico><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4768526216432204" crossorigin=anonymous></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/favicon.ico width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>üêà</span></figure><div class=site-meta><h1 class=site-name><a href=/>/home/nishipy</a></h1><h2 class=site-description></h2></div></header><ol class=social-menu><li><a href=https://github.com/nishipy target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/iamnishipy target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://nishipy.com target=_blank title=Blog rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language-hiragana" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M7 4c0 4.846.0 7 .5 8"/><path d="M10 8.5c0 2.286-2 4.5-3.5 4.5S4 11.865 4 11c0-2 1-3 3-3s5 .57 5 2.857c0 1.524-.667 2.571-2 3.143"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14.828 14.828A4 4 0 109.172 9.172a4 4 0 005.656 5.656z"/><path d="M6.343 17.657l-1.414 1.414"/><path d="M6.343 6.343 4.929 4.929"/><path d="M17.657 6.343l1.414-1.414"/><path d="M17.657 17.657l1.414 1.414"/><path d="M4 12H2"/><path d="M12 4V2"/><path d="M20 12h2"/><path d="M12 20v2"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/></svg></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#pkgkubeletplegpleggo>pkg/kubelet/pleg/pleg.go</a></li><li><a href=#pkgkubeletpleggenericgo>pkg/kubelet/pleg/generic.go</a><ul><li><a href=#genericpleghealthy>*GenericPLEG.Healthy()</a></li><li><a href=#genericplegrelist>*GenericPLEG.relist()</a></li><li><a href=#genericplegstart>*GenericPLEG.Start()</a></li><li><a href=#genericplegwatch>*GenericPLEG.Watch()</a></li></ul></li><li><a href=#pkgkubeletkubeletgo>pkg/kubelet/kubelet.go</a></li><li><a href=#pkgkubeletruntimego>pkg/kubelet/runtime.go</a></li><li><a href=#whats-next-in-pleg>What&rsquo;s next in PLEG?</a></li><li><a href=#references>References</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/understanding-pleg-with-source-code-part-2/><img src=/p/understanding-pleg-with-source-code-part-2/pleg_hu198fe2aa39d96d5ee57c047fcc9cf0ca_184542_800x0_resize_box_3.png srcset="/p/understanding-pleg-with-source-code-part-2/pleg_hu198fe2aa39d96d5ee57c047fcc9cf0ca_184542_800x0_resize_box_3.png 800w, /p/understanding-pleg-with-source-code-part-2/pleg_hu198fe2aa39d96d5ee57c047fcc9cf0ca_184542_1600x0_resize_box_3.png 1600w" width=800 height=588 loading=lazy alt="Featured image of post Understanding PLEG with source code - Part 2"></a></div><div class=article-details><header class=article-category><a href=/categories/kubernetes/>kubernetes</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/understanding-pleg-with-source-code-part-2/>Understanding PLEG with source code - Part 2</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Mar 24, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>19 minute read</time></div></footer></div></header><section class=article-content><section class="toc toc--inline"><h2>Table of contents</h2><div><nav id=TableOfContents><ul><li><a href=#pkgkubeletplegpleggo>pkg/kubelet/pleg/pleg.go</a></li><li><a href=#pkgkubeletpleggenericgo>pkg/kubelet/pleg/generic.go</a><ul><li><a href=#genericpleghealthy>*GenericPLEG.Healthy()</a></li><li><a href=#genericplegrelist>*GenericPLEG.relist()</a></li><li><a href=#genericplegstart>*GenericPLEG.Start()</a></li><li><a href=#genericplegwatch>*GenericPLEG.Watch()</a></li></ul></li><li><a href=#pkgkubeletkubeletgo>pkg/kubelet/kubelet.go</a></li><li><a href=#pkgkubeletruntimego>pkg/kubelet/runtime.go</a></li><li><a href=#whats-next-in-pleg>What&rsquo;s next in PLEG?</a></li><li><a href=#references>References</a></li></ul></nav></div></section><p>For the goal of this series or abstract of the PLEG and so on, please refer to the previous post <a class=link href=https://nishipy.github.io/p/understanding-pleg-with-source-code-part-1/>Understanding PLEG with source code - Part 1</a>.
Now, let&rsquo;s read the source code of PLEG! Note that the source code in the following part comes from <a class=link href=https://github.com/kubernetes/kubernetes/tree/release-1.25 target=_blank rel=noopener><code>Kubernetes 1.25</code></a>.</p><h2 id=pkgkubeletplegpleggo>pkg/kubelet/pleg/pleg.go</h2><p>The types of PodLifeCycleEvents in PLEG and their associated structures and interfaces are defined here.
We have some events like <code>ContainerStarted</code>, <code>ContainerDied</code>, <code>ContainerRemoved</code>, <code>PodSync</code> and <code>ContainerChanged</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// PodLifeCycleEventType define the event type of pod life cycle events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ContainerStarted - event type when the new state of container is running.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ContainerStarted</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> = <span style=color:#e6db74>&#34;ContainerStarted&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ContainerDied - event type when the new state of container is exited.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ContainerDied</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> = <span style=color:#e6db74>&#34;ContainerDied&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ContainerRemoved - event type when the old state of container is exited.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ContainerRemoved</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> = <span style=color:#e6db74>&#34;ContainerRemoved&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// PodSync is used to trigger syncing of a pod when the observed change of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the state of the pod cannot be captured by any single event above.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>PodSync</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> = <span style=color:#e6db74>&#34;PodSync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ContainerChanged - event type when the new state of container is unknown.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ContainerChanged</span> <span style=color:#a6e22e>PodLifeCycleEventType</span> = <span style=color:#e6db74>&#34;ContainerChanged&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// PodLifecycleEvent is an event that reflects the change of the pod state.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PodLifecycleEvent</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The pod ID.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ID</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The type of the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Type</span> <span style=color:#a6e22e>PodLifeCycleEventType</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The accompanied data which varies based on the event type.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   - ContainerStarted/ContainerStopped: the container name (string).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   - All other event types: unused.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Data</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// PodLifecycleEventGenerator contains functions for generating pod life cycle events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PodLifecycleEventGenerator</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Watch</span>() <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Healthy</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=pkgkubeletpleggenericgo>pkg/kubelet/pleg/generic.go</h2><p>The PLEG-related source code is mainly written in this file.
The GenericPLEG structure looks as follows.
As for the Cache, please refer to the <code>Runtime Pod Cache</code> described in the <a class=link href=https://nishipy.github.io/p/understanding-pleg-with-source-code-part-1/>previous article</a>.
Looking at the comments in <code>kubecontainer.Cache interface</code>, Cache seems to store the <code>PodStatus</code> of all containers/pods visible to the container runtime.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GenericPLEG</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The period for relisting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>relistPeriod</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The container runtime.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>runtime</span> <span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Runtime</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The channel from which the subscriber listens events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>eventChannel</span> <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The internal cache for pod/container information.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>podRecords</span> <span style=color:#a6e22e>podRecords</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Time of the last relisting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>relistTime</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cache for storing the runtime states required for syncing pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cache</span> <span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Cache</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// For testability.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>clock</span> <span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Clock</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Pods that failed to have their status retrieved during a relist. These pods will be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// retried during the next relisting.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>podsToReinspect</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Cache stores the PodStatus for the pods. It represents *all* the visible
</span></span></span><span style=display:flex><span><span style=color:#75715e>// pods/containers in the container runtime. All cache entries are at least as
</span></span></span><span style=display:flex><span><span style=color:#75715e>// new or newer than the global timestamp (set by UpdateTime()), while
</span></span></span><span style=display:flex><span><span style=color:#75715e>// individual entries may be slightly newer than the global timestamp. If a pod
</span></span></span><span style=display:flex><span><span style=color:#75715e>// has no states known by the runtime, Cache returns an empty PodStatus object
</span></span></span><span style=display:flex><span><span style=color:#75715e>// with ID populated.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Cache provides two methods to retrieve the PodStatus: the non-blocking Get()
</span></span></span><span style=display:flex><span><span style=color:#75715e>// and the blocking GetNewerThan() method. The component responsible for
</span></span></span><span style=display:flex><span><span style=color:#75715e>// populating the cache is expected to call Delete() to explicitly free the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// cache entries.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Cache</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodStatus</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>PodStatus</span>, <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// GetNewerThan is a blocking call that only returns the status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// when it is newer than the given time.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>GetNewerThan</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PodStatus</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UpdateTime</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The constant definition looks like this: <code>relistThreshold</code> is 3 minutes. When the Kubernetes/OpenShift nodes get NotReady, I saw this threshold in the error message <code>PLEG is not healthy: pleg was last seen active XXmYYs ago; threshold is 3m0s</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// plegContainerState has a one-to-one mapping to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// kubecontainer.State except for the non-existent state. This state
</span></span></span><span style=display:flex><span><span style=color:#75715e>// is introduced here to complete the state transition scenarios.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>plegContainerState</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plegContainerRunning</span>     <span style=color:#a6e22e>plegContainerState</span> = <span style=color:#e6db74>&#34;running&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plegContainerExited</span>      <span style=color:#a6e22e>plegContainerState</span> = <span style=color:#e6db74>&#34;exited&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plegContainerUnknown</span>     <span style=color:#a6e22e>plegContainerState</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plegContainerNonExistent</span> <span style=color:#a6e22e>plegContainerState</span> = <span style=color:#e6db74>&#34;non-existent&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The threshold needs to be greater than the relisting period + the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// relisting time, which can vary significantly. Set a conservative
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// threshold to avoid flipping between healthy and unhealthy.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>relistThreshold</span> = <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=genericpleghealthy>*GenericPLEG.Healthy()</h3><p>The Healthy() method is a pointer method of the GenericPLEG structure. It checks if the PLEG itself is working properly. More specifically, if the interval between two relists exceeds 3 minutes (if <code>elapsed</code> > <code>relistThreshold</code>), the PLEG get failed. Then it reports the errors like <code>PLEG is not healthy: pleg was last seen active XXmYYs ago; threshold is 3m0s</code>.</p><p>It seems that <code>elapsed</code> will measure how much time has elapsed since the <code>relistTime</code>, which is a time of type time.Time and shows the time when the last relist was started).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Healthy check if PLEG work properly.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// relistThreshold is the maximum interval between two relist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Healthy</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>relistTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>getRelistTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>relistTime</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;pleg has yet to be successful&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Expose as metric so you can alert on `time()-pleg_last_seen_seconds &gt; nn`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGLastSeen</span>.<span style=color:#a6e22e>Set</span>(float64(<span style=color:#a6e22e>relistTime</span>.<span style=color:#a6e22e>Unix</span>()))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>relistTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>elapsed</span> &gt; <span style=color:#a6e22e>relistThreshold</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;pleg was last seen active %v ago; threshold is %v&#34;</span>, <span style=color:#a6e22e>elapsed</span>, <span style=color:#a6e22e>relistThreshold</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>getRelistTime</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relistTime</span>.<span style=color:#a6e22e>Load</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>{}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>.(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=genericplegrelist>*GenericPLEG.relist()</h3><p>PLEG&rsquo;s relisting is implemented in the <code>relist()</code> method.
<code>relist()</code> queries the container runtime to obtain a list of pods/containers. It then compares it to the internal pods/containers and generates events accordingly. <code>relist()</code> performs the following steps:</p><p>First, the current time is retrieved. After retrieving all pod information from the container runtime, <code>relistTime</code> is updated as the timestamp of the most recent start of <code>relist()</code>. <code>g.runtime.GetPods(true)</code> is passed with an argument <code>true</code> to retrieve the list of containers including exited and dead ones.
The retrieved list is used to update the data in <code>podRecords</code> (internal cache of pod/container information).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// relist queries the container runtime for list of pods/containers, compare
</span></span></span><span style=display:flex><span><span style=color:#75715e>// with the internal pods/containers, and generates events accordingly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>relist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;GenericPLEG: Relisting&#34;</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastRelistTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>getRelistTime</span>(); !<span style=color:#a6e22e>lastRelistTime</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGRelistInterval</span>.<span style=color:#a6e22e>Observe</span>(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SinceInSeconds</span>(<span style=color:#a6e22e>lastRelistTime</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGRelistDuration</span>.<span style=color:#a6e22e>Observe</span>(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SinceInSeconds</span>(<span style=color:#a6e22e>timestamp</span>))
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get all the pods.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>podList</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>GetPods</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;GenericPLEG: Unable to retrieve pods&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateRelistTime</span>(<span style=color:#a6e22e>timestamp</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pods</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pods</span>(<span style=color:#a6e22e>podList</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update running pod and container count
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>updateRunningPodAndContainerMetrics</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>setCurrent</span>(<span style=color:#a6e22e>pods</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span></code></pre></div><p><code>PodRecord</code> has the <code>old</code> and <code>current</code> fields, and the type of both is type <code>kubecontainer.Pod</code>. <code>kubecontainer.Pod</code> structure looks like as follows and contains information such as Pod name, Namespace, and list of containers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>podRecord</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>old</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>current</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>podRecords</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>podRecord</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Pod is a group of containers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Pod</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The ID of the pod, which can be used to retrieve a particular pod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// from the pod list returned by GetPods().
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>ID</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The name and namespace of the pod, which is readable by human.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Name</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Namespace</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// List of containers that belongs to this pod. It may contain only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// running containers, or mixed with dead ones (when GetPods(true)).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Containers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// List of sandboxes associated with this pod. The sandboxes are converted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// to Container temporarily to avoid substantial changes to other
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// components. This is only populated by kuberuntime.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// TODO: use the runtimeApi.PodSandbox type directly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>Sandboxes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>Container</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s go back to the relist.
For each pod, the current (<code>current</code>) and past (<code>old</code>) status of <code>podRecords</code> will be compared and events will be generated accordingly. The generated events are added to Map <code>eventsByPodID</code>. The pods are walked through one by one from this Map <code>eventsByPodID</code>, and if there is an event, then the <code>PodCache</code> will be updated.</p><p>From <code>case g.eventChannel &lt;- events[i]</code>, we can see that the event will be sent if the PodLyifecycleEvent channel has room.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>relist</span>() {
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Compare the old and the current pods, and generate events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>eventsByPodID</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>oldPod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getOld</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Get all containers in the old and the new pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>allContainers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getContainersFromPods</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allContainers</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>computeEvents</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>updateEvents</span>(<span style=color:#a6e22e>eventsByPodID</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>needsReinspection</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>needsReinspection</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If there are events associated with a pod, we should update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// podCache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>eventsByPodID</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// updateCache() will inspect the pod and update the cache. If an
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// error occurs during the inspection, we want PLEG to retry again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// in the next relist. To achieve this, we do not update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// associated podRecord of the pod, so that the change will be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// detect again in the next relist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// TODO: If many pods changed during the same relist period,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// inspecting the pod and getting the PodStatus to update the cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// serially may take a while. We should be aware of this and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// parallelize if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Rely on updateCache calling GetPodStatus to log the actual error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;PLEG: Ignoring events for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KRef</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>                <span style=color:#75715e>// make sure we try to reinspect the pod during the next relisting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>needsReinspection</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// this pod was in the list to reinspect and we did so because it had events, so remove it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// from the list (we don&#39;t want the reinspection code below to inspect it a second time in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// this relist execution)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                delete(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span>, <span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Update the internal storage and send out the events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Map from containerId to exit code; used as a temporary cache for lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>containerExitCode</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>relist</span>() {
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Compare the old and the current pods, and generate events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>eventsByPodID</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>oldPod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getOld</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Get all containers in the old and the new pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>allContainers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getContainersFromPods</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>container</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>allContainers</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>computeEvents</span>(<span style=color:#a6e22e>oldPod</span>, <span style=color:#a6e22e>pod</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>container</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>updateEvents</span>(<span style=color:#a6e22e>eventsByPodID</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>needsReinspection</span> <span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>needsReinspection</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>kubecontainer</span>.<span style=color:#a6e22e>Pod</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If there are events associated with a pod, we should update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// podCache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>events</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>eventsByPodID</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>getCurrent</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// updateCache() will inspect the pod and update the cache. If an
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// error occurs during the inspection, we want PLEG to retry again
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// in the next relist. To achieve this, we do not update the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// associated podRecord of the pod, so that the change will be
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// detect again in the next relist.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// TODO: If many pods changed during the same relist period,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// inspecting the pod and getting the PodStatus to update the cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// serially may take a while. We should be aware of this and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// parallelize if needed.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Rely on updateCache calling GetPodStatus to log the actual error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;PLEG: Ignoring events for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KRef</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>                <span style=color:#75715e>// make sure we try to reinspect the pod during the next relisting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>needsReinspection</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// this pod was in the list to reinspect and we did so because it had events, so remove it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// from the list (we don&#39;t want the reinspection code below to inspect it a second time in
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// this relist execution)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                delete(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span>, <span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Update the internal storage and send out the events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podRecords</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Map from containerId to exit code; used as a temporary cache for lookup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>containerExitCode</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>events</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Filter out events that are not reliable and no other components use yet.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ContainerChanged</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>eventChannel</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>]:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>PLEGDiscardEvents</span>.<span style=color:#a6e22e>Inc</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#e6db74>&#34;Event channel is full, discard this relist() cycle event&#34;</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Log exit code of containers when they finished in a particular event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ContainerDied</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Fill up containerExitCode map for ContainerDied event when first time appeared
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>containerExitCode</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Get updated podStatus
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>ID</span>)
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>containerStatus</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>ContainerStatuses</span> {
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>containerExitCode</span>[<span style=color:#a6e22e>containerStatus</span>.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>ID</span>] = <span style=color:#a6e22e>containerStatus</span>.<span style=color:#a6e22e>ExitCode</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>containerID</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>events</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Data</span>.(<span style=color:#66d9ef>string</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>exitCode</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>containerExitCode</span>[<span style=color:#a6e22e>containerID</span>]; <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>pod</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Generic (PLEG): container finished&#34;</span>, <span style=color:#e6db74>&#34;podID&#34;</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#e6db74>&#34;containerID&#34;</span>, <span style=color:#a6e22e>containerID</span>, <span style=color:#e6db74>&#34;exitCode&#34;</span>, <span style=color:#a6e22e>exitCode</span>)
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cacheEnabled</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// reinspect any pods that failed inspection during the previous relist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;GenericPLEG: Reinspecting pods that previously failed inspection&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>pod</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>pid</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Rely on updateCache calling GetPodStatus to log the actual error.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>5</span>).<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;PLEG: pod failed reinspection&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KRef</span>(<span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Namespace</span>, <span style=color:#a6e22e>pod</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>needsReinspection</span>[<span style=color:#a6e22e>pid</span>] = <span style=color:#a6e22e>pod</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Update the cache timestamp.  This needs to happen *after*
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// all pods have been properly updated in the cache.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>cache</span>.<span style=color:#a6e22e>UpdateTime</span>(<span style=color:#a6e22e>timestamp</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// make sure we retain the list of pods that need reinspecting the next time relist is called
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>podsToReinspect</span> = <span style=color:#a6e22e>needsReinspection</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Pod Lifecycle Event generation is performed by <code>generateEvents()</code> below. As you can see from the first if statement, if the state is the same as the previous state, no event will be generated.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>generateEvents</span>(<span style=color:#a6e22e>podID</span> <span style=color:#a6e22e>types</span>.<span style=color:#a6e22e>UID</span>, <span style=color:#a6e22e>cid</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>oldState</span>, <span style=color:#a6e22e>newState</span> <span style=color:#a6e22e>plegContainerState</span>) []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newState</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>oldState</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;GenericPLEG&#34;</span>, <span style=color:#e6db74>&#34;podUID&#34;</span>, <span style=color:#a6e22e>podID</span>, <span style=color:#e6db74>&#34;containerID&#34;</span>, <span style=color:#a6e22e>cid</span>, <span style=color:#e6db74>&#34;oldState&#34;</span>, <span style=color:#a6e22e>oldState</span>, <span style=color:#e6db74>&#34;newState&#34;</span>, <span style=color:#a6e22e>newState</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>newState</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>plegContainerRunning</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerStarted</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>plegContainerExited</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerDied</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>plegContainerUnknown</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerChanged</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>plegContainerNonExistent</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>oldState</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>plegContainerExited</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// We already reported that the container died before.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerRemoved</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span>{{<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerDied</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}, {<span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>podID</span>, <span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>ContainerRemoved</span>, <span style=color:#a6e22e>Data</span>: <span style=color:#a6e22e>cid</span>}}
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        panic(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;unrecognized container state: %v&#34;</span>, <span style=color:#a6e22e>newState</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=genericplegstart>*GenericPLEG.Start()</h3><p>In the <code>Start()</code> method, the <code>relist()</code> method will be executed in goroutine. The <code>wait.Until()</code> is used here, hence it loops at <code>relistPeriod</code> (= 1 second) intervals.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Start spawns a goroutine to relist periodically.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relist</span>, <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>relistPeriod</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=genericplegwatch>*GenericPLEG.Watch()</h3><p><code>Watch()</code> is a method that returns a channel for <code>PodLifecycleEvents</code>. It returns the channel <code>*PodLifecycleEvent</code>, and the kubelet receives events from this channel and performs the Pod synchronizations as appropriate.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Watch returns a channel from which the subscriber can receive PodLifecycleEvent
</span></span></span><span style=display:flex><span><span style=color:#75715e>// events.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// TODO: support multiple subscribers.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GenericPLEG</span>) <span style=color:#a6e22e>Watch</span>() <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PodLifecycleEvent</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>eventChannel</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=pkgkubeletkubeletgo>pkg/kubelet/kubelet.go</h2><p>Furthermore, let&rsquo;s see how PLEG is called on the kubelet side. There are some PLEG-related constants: the relist interval is 1 second, and the capacity of the channel for <code>PodLifecycleEvents</code> looks 1000.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>//~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Capacity of the channel for receiving pod lifecycle events. This number
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// is a bit arbitrary and may be adjusted in the future.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>plegChannelCapacity</span> = <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generic PLEG relies on relisting for discovering container events.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// A longer period means that kubelet will take longer to detect container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// changes and to update pod status. On the other hand, a shorter period
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// will cause more frequent relisting (e.g., container runtime operations),
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// leading to higher cpu usage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Note that even though we set the period to 1s, the relisting itself can
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// take more than 1s to finish if the container runtime responds slowly
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// and/or when there are many container changes in one cycle.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>plegRelistPeriod</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>//~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>The NewMainKubelet() will instantiate a new Kubelet object along with all necessary internal modules. The PLEG-related processing is as follows. After instantiating the <code>GenericPLEG</code> object in <code>NewGenericPLEG()</code>, it will be added to the health check mechanism in the main loop of the kubelet. As a result, we sometimes see the error messages like <code>the PLEG is not healthy: pleg was last seen active XXmYYs ago; threshold is 3m0s</code> in the kubelet log.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// No initialization of Kubelet and its modules should happen here.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewMainKubelet</span>(<span style=color:#a6e22e>kubeCfg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>kubeletconfiginternal</span>.<span style=color:#a6e22e>KubeletConfiguration</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kubeDeps</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Dependencies</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>crOptions</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>ContainerRuntimeOptions</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hostname</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hostnameOverridden</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>seccompDefault</span> <span style=color:#66d9ef>bool</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>pleg</span> = <span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>NewGenericPLEG</span>(<span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>containerRuntime</span>, <span style=color:#a6e22e>plegChannelCapacity</span>, <span style=color:#a6e22e>plegRelistPeriod</span>, <span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>podCache</span>, <span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>RealClock</span>{})
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>runtimeState</span> = <span style=color:#a6e22e>newRuntimeState</span>(<span style=color:#a6e22e>maxWaitForContainerRuntime</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>runtimeState</span>.<span style=color:#a6e22e>addHealthCheck</span>(<span style=color:#e6db74>&#34;PLEG&#34;</span>, <span style=color:#a6e22e>klet</span>.<span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>Healthy</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can see that PLEG is also started with <code>kl.pleg.Start()</code> in the <code>Run()</code> method on the kubelet side.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Run starts the kubelet reacting to config updates
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>logServer</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>logServer</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StripPrefix</span>(<span style=color:#e6db74>&#34;/logs/&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileServer</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Dir</span>(<span style=color:#e6db74>&#34;/var/log/&#34;</span>)))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeClient</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;No API server defined - no node status update will be sent&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start the cloud provider sync manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cloudResourceSyncManager</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cloudResourceSyncManager</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>initializeModules</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>recorder</span>.<span style=color:#a6e22e>Eventf</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeRef</span>, <span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>EventTypeWarning</span>, <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>KubeletSetupFailed</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Failed to initialize internal modules&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Exit</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start volume manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>volumeManager</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>sourcesReady</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>kubeClient</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Introduce some small jittering to ensure that over time the requests won&#39;t start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// accumulating at approximately the same time from the set of nodes due to priority and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// fairness effect.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>JitterUntil</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncNodeStatus</span>, <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeStatusUpdateFrequency</span>, <span style=color:#ae81ff>0.04</span>, <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>fastStatusUpdateOnce</span>()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#75715e>// start syncing lease
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>nodeLeaseController</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>Until</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>updateRuntimeUp</span>, <span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>, <span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Set up iptables util rules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>makeIPTablesUtilChains</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>initNetworkUtil</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start component sync loops.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>statusManager</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start syncing RuntimeClasses if enabled.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeClassManager</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeClassManager</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>wait</span>.<span style=color:#a6e22e>NeverStop</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start the pod lifecycle event generator.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoop</span>(<span style=color:#a6e22e>updates</span>, <span style=color:#a6e22e>kl</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>At the end of the <code>Run()</code> method, the <code>syncLoop()</code> method is also called. The <code>plegCh := kl.pleg.Watch()</code> part in <code>syncLoop()</code> obtains a channel to read PLEG updates and receives events generated by PLEG via the channel.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style=display:flex><span><span style=color:#75715e>// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style=display:flex><span><span style=color:#75715e>// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style=display:flex><span><span style=color:#75715e>// state every sync-frequency seconds. Never returns.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>syncLoop</span>(<span style=color:#a6e22e>updates</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>, <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>SyncHandler</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;Starting kubelet main sync loop&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// The syncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// sync interval is defaulted to 10s.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>syncTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>syncTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>housekeepingTicker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>housekeepingPeriod</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>housekeepingTicker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>plegCh</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>Watch</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>base</span>   = <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>max</span>    = <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>factor</span> = <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>base</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Responsible for checking limits in resolv.conf
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// The limits do not have anything to do with individual pods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Since this is called in syncLoop, we don&#39;t need to call it anywhere else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span>.<span style=color:#a6e22e>ResolverConfig</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>dnsConfigurer</span>.<span style=color:#a6e22e>CheckLimitsForResolvConf</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>runtimeState</span>.<span style=color:#a6e22e>runtimeErrors</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>ErrorS</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;Skipping pod synchronization&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e>// exponential backoff
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>duration</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>duration</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(float64(<span style=color:#a6e22e>max</span>), <span style=color:#a6e22e>factor</span><span style=color:#f92672>*</span>float64(<span style=color:#a6e22e>duration</span>)))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// reset backoff if we have a success
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>duration</span> = <span style=color:#a6e22e>base</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopMonitor</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopIteration</span>(<span style=color:#a6e22e>updates</span>, <span style=color:#a6e22e>handler</span>, <span style=color:#a6e22e>syncTicker</span>.<span style=color:#a6e22e>C</span>, <span style=color:#a6e22e>housekeepingTicker</span>.<span style=color:#a6e22e>C</span>, <span style=color:#a6e22e>plegCh</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>syncLoopMonitor</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>clock</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>syncLoopIteration()</code> is a method that reads various channels and dispatches them to a given Handler. The <code>plegCh</code> channel is described as being used for Runtime Cache updates and Pod synchronization. For example, if the kubelet receives the event PLEG&rsquo;s <code>ContainerDied</code> (= the latest container state is Exited), the kubelet will delete the container instance in question in the pod via <code>cleanUpContainersInPod()</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// syncLoopIteration reads from various channels and dispatches pods to the
</span></span></span><span style=display:flex><span><span style=color:#75715e>// given handler.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Arguments:
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 1.  configCh:       a channel to read config events from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 2.  handler:        the SyncHandler to dispatch pods to
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 3.  syncCh:         a channel to read periodic sync events from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 4.  housekeepingCh: a channel to read housekeeping events from
</span></span></span><span style=display:flex><span><span style=color:#75715e>// 5.  plegCh:         a channel to read PLEG updates from
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Events are also read from the kubelet liveness manager&#39;s update channel.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// The workflow is to read from one of the channels, handle that event, and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// update the timestamp in the sync loop monitor.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Here is an appropriate place to note that despite the syntactical
</span></span></span><span style=display:flex><span><span style=color:#75715e>// similarity to the switch statement, the case statements in a select are
</span></span></span><span style=display:flex><span><span style=color:#75715e>// evaluated in a pseudorandom order if there are multiple channels ready to
</span></span></span><span style=display:flex><span><span style=color:#75715e>// read from when the select is evaluated.  In other words, case statements
</span></span></span><span style=display:flex><span><span style=color:#75715e>// are evaluated in random order, and you can not assume that the case
</span></span></span><span style=display:flex><span><span style=color:#75715e>// statements evaluate in order if multiple channels have events.
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// With that in mind, in truly no particular order, the different channels
</span></span></span><span style=display:flex><span><span style=color:#75715e>// are handled as follows:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   - configCh: dispatch the pods for the config change to the appropriate
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     handler callback for the event type
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   - plegCh: update the runtime cache; sync pod
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   - syncCh: sync all pods waiting for sync
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   - housekeepingCh: trigger cleanup of pods
</span></span></span><span style=display:flex><span><span style=color:#75715e>//   - health manager: sync pods that have failed or in which one or more
</span></span></span><span style=display:flex><span><span style=color:#75715e>//     containers have failed health checks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Kubelet</span>) <span style=color:#a6e22e>syncLoopIteration</span>(<span style=color:#a6e22e>configCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>kubetypes</span>.<span style=color:#a6e22e>PodUpdate</span>, <span style=color:#a6e22e>handler</span> <span style=color:#a6e22e>SyncHandler</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>syncCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>housekeepingCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#a6e22e>plegCh</span> <span style=color:#f92672>&lt;-</span><span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>PodLifecycleEvent</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ~~
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>plegCh</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>ContainerStarted</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// record the most recent time we observed a container start for this pod.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// this lets us selectively invalidate the runtimeCache when processing a delete for this pod
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>// to make sure we don&#39;t miss handling graceful termination for containers we reported as having started.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>lastContainerStartedTime</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>isSyncPodWorthy</span>(<span style=color:#a6e22e>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// PLEG event for a pod; sync it.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>pod</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>podManager</span>.<span style=color:#a6e22e>GetPodByUID</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ID</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>2</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (PLEG): event for pod&#34;</span>, <span style=color:#e6db74>&#34;pod&#34;</span>, <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>KObj</span>(<span style=color:#a6e22e>pod</span>), <span style=color:#e6db74>&#34;event&#34;</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>HandlePodSyncs</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>v1</span>.<span style=color:#a6e22e>Pod</span>{<span style=color:#a6e22e>pod</span>})
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// If the pod no longer exists, ignore the event.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>klog</span>.<span style=color:#a6e22e>V</span>(<span style=color:#ae81ff>4</span>).<span style=color:#a6e22e>InfoS</span>(<span style=color:#e6db74>&#34;SyncLoop (PLEG): pod does not exist, ignore irrelevant event&#34;</span>, <span style=color:#e6db74>&#34;event&#34;</span>, <span style=color:#a6e22e>e</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Type</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>pleg</span>.<span style=color:#a6e22e>ContainerDied</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>containerID</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Data</span>.(<span style=color:#66d9ef>string</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kl</span>.<span style=color:#a6e22e>cleanUpContainersInPod</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>containerID</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>// ~~
</span></span></span></code></pre></div><h2 id=pkgkubeletruntimego>pkg/kubelet/runtime.go</h2><p>Let&rsquo;s also look at where the PLEG-related health check is added to the kubelet runtime health check with <code>klet.runtimeState</code>.The health check functions, which were added by <code>addHealthCheck()</code>, will be called with the <code>for</code> statement and evaluated. When the health check fails, the error message will be shown with a format like <code>fmt.Errorf("%s is not healthy: %v", hc.name, err)</code>.
Yeah, now we can see where <code>PLEG is not healthy: pleg was last seen active XXmYYs ago; threshold is 3m</code> comes from!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// A health check function should be efficient and not rely on external
</span></span></span><span style=display:flex><span><span style=color:#75715e>// components (e.g., container runtime).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>healthCheckFnType</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>healthCheck</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span>   <span style=color:#a6e22e>healthCheckFnType</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtimeState</span>) <span style=color:#a6e22e>addHealthCheck</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>f</span> <span style=color:#a6e22e>healthCheckFnType</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>healthChecks</span> = append(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>healthChecks</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>healthCheck</span>{<span style=color:#a6e22e>name</span>: <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>fn</span>: <span style=color:#a6e22e>f</span>})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>runtimeState</span>) <span style=color:#a6e22e>runtimeErrors</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errs</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>error</span>{}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>lastBaseRuntimeSync</span>.<span style=color:#a6e22e>IsZero</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;container runtime status check may not have completed yet&#34;</span>))
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>lastBaseRuntimeSync</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>baseRuntimeSyncThreshold</span>).<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;container runtime is down&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>hc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>healthChecks</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>fn</span>(); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;%s is not healthy: %v&#34;</span>, <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>runtimeError</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errs</span> = append(<span style=color:#a6e22e>errs</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>runtimeError</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>utilerrors</span>.<span style=color:#a6e22e>NewAggregate</span>(<span style=color:#a6e22e>errs</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=whats-next-in-pleg>What&rsquo;s next in PLEG?</h2><p>I found the KEP <code>Kubelet Evented PLEG for Better Performance</code>. It seems still under development for now.</p><ul><li><a class=link href=https://github.com/kubernetes/enhancements/issues/3386 target=_blank rel=noopener>Isuue: Kubelet Evented PLEG for Better Performance - GitHub</a></li></ul><h2 id=references>References</h2><ul><li><a class=link href=https://access.redhat.com/solutions/3258011 target=_blank rel=noopener>&ldquo;PLEG is not healthy&rdquo; errors on OpenShift nodes. - Red Hat Customer Portal</a></li><li><a class=link href=https://kubernetes.io/ja/docs/concepts/ target=_blank rel=noopener>„Ç≥„É≥„Çª„Éó„Éà - Kubernetes Document</a></li><li><a class=link href=https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes# target=_blank rel=noopener>Pod Lifecycle Event Generator: Understanding the ‚ÄúPLEG is not healthy‚Äù issue in Kubernetes - Red Hat Developer</a></li><li><a class=link href=https://github.com/kubernetes/design-proposals-archive target=_blank rel=noopener>kubernetes/design-proposals-archive - GitHub</a></li><li><a class=link href=https://github.com/kubernetes/kubernetes/tree/release-1.25/pkg/kubelet/pleg target=_blank rel=noopener>kubernetes/pkg/kubelet/pleg at release-1.25 - GitHub</a></li><li><a class=link href=https://github.com/kubernetes/enhancements/issues/3386 target=_blank rel=noopener>Isuue: Kubelet Evented PLEG for Better Performance - GitHub</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/kubernetes/>kubernetes</a>
<a href=/tags/openshift/>openshift</a>
<a href=/tags/kubelet/>kubelet</a>
<a href=/tags/pleg/>pleg</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=share-buttons><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Understanding%20PLEG%20with%20source%20code%20-%20Part%202&url=https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f&title=Understanding%20PLEG%20with%20source%20code%20-%20Part%202&summary=Understanding%20PLEG%20with%20source%20code%20-%20Part%202&source=https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6.0 2.5 1 2.6 2.5.0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f&resubmit=true&title=Understanding%20PLEG%20with%20source%20code%20-%20Part%202" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Understanding%20PLEG%20with%20source%20code%20-%20Part%202%20https%3a%2f%2fnishipy.github.io%2fp%2funderstanding-pleg-with-source-code-part-2%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/understanding-pleg-with-source-code-part-1/><div class=article-image><img src=/p/understanding-pleg-with-source-code-part-1/pleg.75c280ae605e2df67f4b1fd155383d4a_hu198fe2aa39d96d5ee57c047fcc9cf0ca_184542_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Understanding PLEG with source code - Part 1" data-hash="md5-dcKArmBeLfZ/Sx/RVTg9Sg=="></div><div class=article-details><h2 class=article-title>Understanding PLEG with source code - Part 1</h2></div></a></article><article class=has-image><a href=/p/resource-allocation-to-kind-nodes/><div class=article-image><img src=/p/resource-allocation-to-kind-nodes/logo.9f308edfca7229379837667e61d876f4_hu3178206b939ba8d9865acabeaf6111f4_85649_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Resource allocation to Kind nodes " data-hash="md5-nzCO38pyKTeYN2Z+Ydh29A=="></div><div class=article-details><h2 class=article-title>Resource allocation to Kind nodes</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2018 -
2023 /home/nishipy</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>